-- This file and its contents are licensed under the Timescale License.
-- Please see the included NOTICE for copyright information and
-- LICENSE-TIMESCALE for a copy of the license.
-------------------------------------------------------------------
-- Upsert tests
-------------------------------------------------------------------
-- Explain test
CREATE TABLE explain_test(ts timestamptz, device_id int, metric text, value float);
SELECT create_hypertable('explain_test', by_range('ts'));
 create_hypertable 
-------------------
 (1,t)

CREATE UNIQUE INDEX idx_explain ON explain_test(device_id, metric, ts);
ALTER TABLE explain_test SET (timescaledb.compress, timescaledb.compress_segmentby ='');
INSERT INTO explain_test
SELECT '2024-01-01'::timestamptz + (i || ' minutes')::interval, i % 10, 'temp', i
FROM generate_series(1, 5000) i;
SELECT count(compress_chunk(c)) FROM show_chunks('explain_test') c;
 count 
-------
     2

BEGIN;
EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO explain_test VALUES ('2024-01-01 00:05:30', 5, 'temp', 100)
ON CONFLICT (device_id, metric, ts) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 2
   Batches checked by bloom: 2
   Batches pruned by bloom: 2
   ->  Insert on explain_test (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_explain
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

ROLLBACK;
EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO explain_test VALUES ('2024-01-01 00:05:30', 5, 'temp', 100)
ON CONFLICT (device_id, metric, ts)
DO UPDATE SET value = EXCLUDED.value;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 2
   Batches checked by bloom: 2
   Batches pruned by bloom: 2
   ->  Insert on explain_test (actual rows=0.00 loops=1)
         Conflict Resolution: UPDATE
         Conflict Arbiter Indexes: idx_explain
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

DROP TABLE IF EXISTS explain_test CASCADE;
-------------------------------------------------------------------
CREATE TABLE upsert_test(ts timestamptz, uid int, event text, seg int);
SELECT create_hypertable('upsert_test', by_range('ts'));
 create_hypertable 
-------------------
 (3,t)

CREATE UNIQUE INDEX idx_uid_event ON upsert_test (uid, event, ts);
ALTER TABLE upsert_test SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'seg'
);
INSERT INTO upsert_test
SELECT '2024-01-01'::timestamptz + (i || ' minutes')::interval,
       (i % 100) + 1,
       CASE WHEN i % 3 = 0 THEN 'login' WHEN i % 3 = 1 THEN 'logout' ELSE 'click' END,
       i % 5
FROM generate_series(1, 5000) i;
SELECT compress_chunk(c) FROM show_chunks('upsert_test') c;
             compress_chunk             
----------------------------------------
 _timescaledb_internal._hyper_3_5_chunk
 _timescaledb_internal._hyper_3_6_chunk

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_test VALUES ('2024-01-01 00:03:00', 1, 'login', 1)
ON CONFLICT (uid, event, ts) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   ->  Insert on upsert_test (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_uid_event
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_test VALUES ('2024-01-01 00:03:30', 50, 'login', 1)
ON CONFLICT (uid, event, ts) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 3
   Batches checked by bloom: 3
   Batches pruned by bloom: 3
   ->  Insert on upsert_test (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_uid_event
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

DROP TABLE upsert_test CASCADE;
-------------------------------------------------------------------
CREATE TABLE upsert_temporal(
    time TIMESTAMPTZ NOT NULL,
    sensor_id INT,
    metric TEXT,
    value FLOAT
);
SELECT create_hypertable('upsert_temporal', 'time');
      create_hypertable       
------------------------------
 (5,public,upsert_temporal,t)

CREATE UNIQUE INDEX idx_unique ON upsert_temporal(sensor_id, metric, time);
ALTER TABLE upsert_temporal SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = ''
);
INSERT INTO upsert_temporal
SELECT t, (EXTRACT(HOUR FROM t)::int % 10) + 1, 'temp', 25.5
FROM generate_series('2024-01-01'::timestamptz, '2024-01-31'::timestamptz, '1 hour') t;
-- sensor_id: 1-10, time: whole hours
SELECT compress_chunk(c) FROM show_chunks('upsert_temporal') c;
             compress_chunk              
-----------------------------------------
 _timescaledb_internal._hyper_5_9_chunk
 _timescaledb_internal._hyper_5_10_chunk
 _timescaledb_internal._hyper_5_11_chunk
 _timescaledb_internal._hyper_5_12_chunk
 _timescaledb_internal._hyper_5_13_chunk

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_temporal VALUES ('2024-01-15 10:00:00', 1, 'temp', 26.0)
ON CONFLICT (sensor_id, metric, time) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 1
   Batches checked by bloom: 1
   ->  Insert on upsert_temporal (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_unique
         Tuples Inserted: 0
         Conflicting Tuples: 1
         ->  Result (actual rows=1.00 loops=1)

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_temporal VALUES ('2024-01-15 10:30:00', 5, 'temp', 26.0)
ON CONFLICT (sensor_id, metric, time) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 1
   Batches checked by bloom: 1
   Batches pruned by bloom: 1
   ->  Insert on upsert_temporal (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_unique
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

DROP TABLE upsert_temporal CASCADE;
-------------------------------------------------------------------
CREATE TABLE upsert_demographics(
    time TIMESTAMPTZ NOT NULL,
    user_id INT,
    age SMALLINT,
    gender SMALLINT,
    value INT
);
SELECT create_hypertable('upsert_demographics', 'time');
        create_hypertable         
----------------------------------
 (7,public,upsert_demographics,t)

CREATE UNIQUE INDEX idx_demo ON upsert_demographics(user_id, age, gender, time);
ALTER TABLE upsert_demographics SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = ''
);
INSERT INTO upsert_demographics
SELECT '2024-01-01'::timestamptz + (i || ' minutes')::interval,
       (i % 100) + 1,      -- user_id: 1-100
       (18 + (i % 50)),    -- age: 18-67
       (i % 2) + 1,        -- gender: 1-2
       i
FROM generate_series(1, 2000) i;
SELECT compress_chunk(c) FROM show_chunks('upsert_demographics') c;
             compress_chunk              
-----------------------------------------
 _timescaledb_internal._hyper_7_19_chunk

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_demographics VALUES ('2024-01-01 00:01:00', 1, 18, 1, 200)
ON CONFLICT (user_id, age, gender, time) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 1
   Batches checked by bloom: 1
   Batches pruned by bloom: 1
   ->  Insert on upsert_demographics (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_demo
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO upsert_demographics VALUES ('2024-01-01 00:01:30', 50, 30, 1, 200)
ON CONFLICT (user_id, age, gender, time) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 1
   Batches checked by bloom: 1
   Batches pruned by bloom: 1
   ->  Insert on upsert_demographics (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_demo
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

DROP TABLE upsert_demographics CASCADE;
-------------------------------------------------------------------
CREATE TABLE explain_partial(ts timestamptz, device_id int, metric text, value float);
SELECT create_hypertable('explain_partial', by_range('ts'));
 create_hypertable 
-------------------
 (9,t)

CREATE UNIQUE INDEX idx_partial ON explain_partial(device_id, metric, ts);
-- Manually configure compression with only partial bloom (device_id, metric)
-- This is a SUBSET of the conflict columns (device_id, metric, ts)
ALTER TABLE explain_partial SET (
    timescaledb.compress,
    timescaledb.order_by = 'ts',
    timescaledb.compress_segmentby = '',
    timescaledb.compress_index = 'bloom(device_id, metric)'
);
WARNING:  column "device_id" should be used for segmenting or ordering
WARNING:  column "metric" should be used for segmenting or ordering
INSERT INTO explain_partial
SELECT '2024-01-01'::timestamptz + (i || ' minutes')::interval,
       i % 10, 'temp', i
FROM generate_series(1, 1000) i;
SELECT compress_chunk(c) FROM show_chunks('explain_partial') c;
             compress_chunk              
-----------------------------------------
 _timescaledb_internal._hyper_9_21_chunk

BEGIN;
EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO explain_partial VALUES ('2024-01-01 00:05:30', 5, 'temp', 100)
ON CONFLICT (device_id, metric, ts) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches filtered: 1
   Batches scanned: 1
   Batches checked by bloom: 1
   Batches bloom false positives: 1
   ->  Insert on explain_partial (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_partial
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

ROLLBACK;
EXPLAIN (ANALYZE, BUFFERS OFF, COSTS OFF, TIMING OFF, SUMMARY OFF)
INSERT INTO explain_partial VALUES ('2024-01-01 00:05:00', 5, 'humidity', 100)
ON CONFLICT (device_id, metric, ts) DO NOTHING;
--- QUERY PLAN ---
 Custom Scan (ModifyHypertable) (actual rows=0.00 loops=1)
   Batches scanned: 1
   Batches checked by bloom: 1
   Batches pruned by bloom: 1
   ->  Insert on explain_partial (actual rows=0.00 loops=1)
         Conflict Resolution: NOTHING
         Conflict Arbiter Indexes: idx_partial
         Tuples Inserted: 1
         Conflicting Tuples: 0
         ->  Result (actual rows=1.00 loops=1)

