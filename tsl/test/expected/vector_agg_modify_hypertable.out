-- This file and its contents are licensed under the Timescale License.
-- Please see the included NOTICE for copyright information and
-- LICENSE-TIMESCALE for a copy of the license.
-- Test for vectorized aggregation under ModifyHypertable plan node.
-- This validates that INSERT INTO hypertable SELECT ... GROUP BY ...
-- can use vectorized aggregation for the SELECT portion.
--
-- PR #9137 adds ModifyHypertable to the list of custom scan nodes
-- that try_insert_vector_agg_node() recurses into.
\c :TEST_DBNAME :ROLE_SUPERUSER
-- Create a source hypertable with compressed data
CREATE TABLE source_ht(time int NOT NULL, device_id int, value int);
SELECT create_hypertable('source_ht', 'time', chunk_time_interval => 10000);
   create_hypertable    
------------------------
 (1,public,source_ht,t)

INSERT INTO source_ht
SELECT t, d, t * 10 + d
FROM generate_series(1, 20000) t,
     generate_series(1, 5) d;
ALTER TABLE source_ht SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'device_id',
    timescaledb.compress_orderby = 'time'
);
SELECT count(compress_chunk(ch)) FROM show_chunks('source_ht') ch;
 count 
-------
     3

VACUUM ANALYZE source_ht;
-- Create a target hypertable for aggregated data
CREATE TABLE target_ht(device_id int NOT NULL, total bigint, cnt bigint);
SELECT create_hypertable('target_ht', 'device_id', chunk_time_interval => 10);
   create_hypertable    
------------------------
 (3,public,target_ht,t)

-- Require vectorized aggregation. The INSERT will fail if vectorization
-- is not used, which would happen without the PR #9137 code change.
SET timescaledb.debug_require_vector_agg = 'require';
INSERT INTO target_ht
SELECT device_id, sum(value), count(*)
FROM source_ht
GROUP BY device_id;
RESET timescaledb.debug_require_vector_agg;
-- Verify data was inserted correctly
SELECT count(*) FROM target_ht;
 count 
-------
     5

-- Verify aggregated values are correct
SELECT device_id, total, cnt
FROM target_ht
ORDER BY device_id;
 device_id |   total    |  cnt  
-----------+------------+-------
         1 | 2000120000 | 20000
         2 | 2000140000 | 20000
         3 | 2000160000 | 20000
         4 | 2000180000 | 20000
         5 | 2000200000 | 20000

-- Cleanup
DROP TABLE target_ht;
DROP TABLE source_ht;
