# This workflow verifies that new tests fail when run against old code.
# It helps ensure tests are actually testing the new functionality.
name: Tests should fail on old code

"on":
  push:
    branches:
      - main
      - prerelease_test
    paths-ignore:
      - '**.md'
      - 'LICENSE*'
      - NOTICE
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LICENSE*'
      - NOTICE

jobs:
  verify-tests-fail:
    name: Verify tests fail on old code
    runs-on: ubuntu-latest

    env:
      PG_SRC_DIR: pgbuild
      PG_INSTALL_DIR: postgresql
      PG_VERSION: "17.2"

    steps:
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install flex bison lcov systemd-coredump gdb libipc-run-perl \
          libtest-most-perl pkgconf cmake

    - name: Checkout TimescaleDB
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for code and test changes
      id: check
      run: |
        if [[ "${{ github.event_name }}" != "pull_request" ]]; then
          echo "Not a pull request, skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        git fetch origin ${{ github.base_ref }}:base

        # Check for source code changes (excluding tests)
        CODE_CHANGES=$(git diff --name-only base HEAD -- \
          'src/**/*.c' 'src/**/*.h' \
          'tsl/src/**/*.c' 'tsl/src/**/*.h' \
          | grep -v '_test\.' | head -1 || true)

        # Get list of changed test files (sql only)
        CHANGED_TESTS=$(git diff --name-only base HEAD -- \
          'tsl/test/sql/*.sql' 'test/sql/*.sql' \
          | xargs -I{} basename {} .sql 2>/dev/null | sort -u | tr '\n' ' ' || true)

        if [[ -z "$CODE_CHANGES" ]]; then
          echo "No code changes found, skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [[ -z "$CHANGED_TESTS" ]]; then
          echo "No test changes found, skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Code changes detected"
        echo "Changed tests: $CHANGED_TESTS"
        echo "should_run=true" >> $GITHUB_OUTPUT
        echo "changed_tests=$CHANGED_TESTS" >> $GITHUB_OUTPUT

    - name: Get date for build caching
      if: steps.check.outputs.should_run == 'true'
      id: get-date
      run: echo "date=$(date +"%d")" >> $GITHUB_OUTPUT

    - name: Cache PostgreSQL
      if: steps.check.outputs.should_run == 'true'
      id: cache-postgresql
      uses: actions/cache@v4
      with:
        path: ~/${{ env.PG_SRC_DIR }}
        key: "ubuntu-latest-postgresql-${{ env.PG_VERSION }}-${{ steps.get-date.outputs.date }}-${{ hashFiles('.github/**') }}"

    - name: Build PostgreSQL
      if: steps.check.outputs.should_run == 'true' && steps.cache-postgresql.outputs.cache-hit != 'true'
      run: |
        wget -q -O postgresql.tar.bz2 \
          https://ftp.postgresql.org/pub/source/v$PG_VERSION/postgresql-$PG_VERSION.tar.bz2
        mkdir -p ~/$PG_SRC_DIR
        tar --extract --file postgresql.tar.bz2 --directory ~/$PG_SRC_DIR --strip-components 1
        cd ~/$PG_SRC_DIR
        ./configure --prefix=$HOME/$PG_INSTALL_DIR --with-openssl \
          --without-readline --without-zlib --without-libxml
        make -j $(getconf _NPROCESSORS_ONLN)

    - name: Install PostgreSQL
      if: steps.check.outputs.should_run == 'true'
      run: |
        make -C ~/$PG_SRC_DIR install
        echo "$HOME/$PG_INSTALL_DIR/bin" >> $GITHUB_PATH

    - name: Revert code changes, keep test changes
      if: steps.check.outputs.should_run == 'true'
      run: |
        CODE_FILES=$(git diff --name-only base HEAD -- \
          'src/**/*.c' 'src/**/*.h' \
          'tsl/src/**/*.c' 'tsl/src/**/*.h' \
          | grep -v '_test\.' || true)

        if [[ -n "$CODE_FILES" ]]; then
          echo "Reverting code changes:"
          echo "$CODE_FILES"
          echo "$CODE_FILES" | xargs git checkout base --
        fi

    - name: Build TimescaleDB with old code
      if: steps.check.outputs.should_run == 'true'
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DPG_SOURCE_DIR=$HOME/$PG_SRC_DIR \
          -DPG_PATH=$HOME/$PG_INSTALL_DIR
        make -j $(getconf _NPROCESSORS_ONLN) -C build
        make -C build install

    - name: Verify each changed test fails
      if: steps.check.outputs.should_run == 'true'
      run: |
        TESTS="${{ steps.check.outputs.changed_tests }}"
        FAILED_TESTS=""
        PASSED_TESTS=""

        for TEST in $TESTS; do
          echo "Running test: $TEST"
          if make -C build installcheck TESTS="$TEST" > /dev/null 2>&1; then
            PASSED_TESTS="$PASSED_TESTS $TEST"
            echo "  PASSED (unexpected)"
          else
            FAILED_TESTS="$FAILED_TESTS $TEST"
            echo "  FAILED (expected)"
          fi
        done

        echo ""
        echo "=== Summary ==="
        if [[ -n "$FAILED_TESTS" ]]; then
          echo "Tests that failed as expected:$FAILED_TESTS"
        fi

        if [[ -n "$PASSED_TESTS" ]]; then
          echo ""
          echo "ERROR: The following tests PASSED when they should have FAILED:"
          echo " $PASSED_TESTS"
          echo ""
          echo "This suggests these tests may not be testing the new code changes."
          echo "Please verify that your tests actually exercise the new functionality."
          exit 1
        fi

        echo ""
        echo "All changed tests failed as expected."
