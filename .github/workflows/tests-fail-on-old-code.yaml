# This workflow verifies that new tests fail when run against old code.
# It helps ensure tests are actually testing the new functionality.
name: Tests should fail on old code

"on":
  push:
    branches:
      - main
  pull_request:

jobs:
  verify-tests-fail:
    name: Verify tests fail on old code
    runs-on: ubuntu-latest

    env:
      PG_SRC_DIR: pgbuild
      PG_INSTALL_DIR: postgresql

    steps:
    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install flex bison cmake

    - name: Checkout TimescaleDB
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Read configuration
      id: config
      run: python -B .github/gh_config_reader.py

    - name: Check for code and test changes
      id: check
      run: |
        git fetch origin ${{ github.base_ref }}:base

        # Code changes: anything under src/ directories
        CODE_CHANGES=$(git diff --name-only base HEAD -- 'src/' 'tsl/src/' | head -1 || true)

        # Test changes: changed .out files under test/expected directories
        CHANGED_OUT_FILES=$(git diff --name-only base HEAD -- \
          'test/expected/*.out' 'tsl/test/expected/*.out' || true)

        if [[ -z "$CODE_CHANGES" ]]; then
          echo "No code changes found, skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [[ -z "$CHANGED_OUT_FILES" ]]; then
          echo "No test output changes found, skipping"
          echo "should_run=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Extract test names from changed .out files (handle versioned tests like cagg-17.out)
        CHANGED_TESTS=$(echo "$CHANGED_OUT_FILES" | xargs -I{} basename {} .out | sed 's/-[0-9]*$//' | sort -u | tr '\n' ' ')

        echo "Code changes detected"
        echo "Changed test outputs: $CHANGED_OUT_FILES"
        echo "Test names: $CHANGED_TESTS"
        echo "should_run=true" >> $GITHUB_OUTPUT
        echo "changed_tests=$CHANGED_TESTS" >> $GITHUB_OUTPUT

    # We are going to rebuild Postgres daily, so that it doesn't suddenly break
    # ages after the original problem.
    - name: Get date for build caching
      if: steps.check.outputs.should_run == 'true'
      id: get-date
      run: |
        echo "date=$(date +"%d")" >> $GITHUB_OUTPUT

    # we cache the build directory instead of the install directory here
    # because extension installation will write files to install directory
    # leading to a tainted cache
    - name: Cache PostgreSQL ${{ steps.config.outputs.PG17_LATEST }}
      if: steps.check.outputs.should_run == 'true'
      id: cache-postgresql
      uses: actions/cache@v4
      with:
        path: ~/${{ env.PG_SRC_DIR }}
        key: "ubuntu-latest-postgresql-${{ steps.config.outputs.PG17_LATEST }}-${{ steps.get-date.outputs.date }}-${{ hashFiles('.github/**') }}"

    - name: Build PostgreSQL ${{ steps.config.outputs.PG17_LATEST }}
      if: steps.check.outputs.should_run == 'true' && steps.cache-postgresql.outputs.cache-hit != 'true'
      run: |
        wget -q -O postgresql.tar.bz2 \
          https://ftp.postgresql.org/pub/source/v${{ steps.config.outputs.PG17_LATEST }}/postgresql-${{ steps.config.outputs.PG17_LATEST }}.tar.bz2
        mkdir -p ~/$PG_SRC_DIR
        tar --extract --file postgresql.tar.bz2 --directory ~/$PG_SRC_DIR --strip-components 1
        cd ~/$PG_SRC_DIR
        ./configure --prefix=$HOME/$PG_INSTALL_DIR --with-openssl \
          --without-readline --without-zlib --without-libxml
        make -j $(getconf _NPROCESSORS_ONLN)

    - name: Install PostgreSQL ${{ steps.config.outputs.PG17_LATEST }}
      if: steps.check.outputs.should_run == 'true'
      run: |
        cd ~/$PG_SRC_DIR
        make install
        echo "$HOME/$PG_INSTALL_DIR/bin" >> $GITHUB_PATH

    - name: Revert code changes, keep test changes
      if: steps.check.outputs.should_run == 'true'
      run: |
        CODE_FILES=$(git diff --name-only base HEAD -- 'src/' 'tsl/src/' || true)

        if [[ -n "$CODE_FILES" ]]; then
          echo "Reverting code changes:"
          echo "$CODE_FILES"
          echo "$CODE_FILES" | xargs git checkout base --
        fi

    - name: Build TimescaleDB
      if: steps.check.outputs.should_run == 'true'
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DPG_SOURCE_DIR=$HOME/$PG_SRC_DIR \
          -DPG_PATH=$HOME/$PG_INSTALL_DIR
        make -j $(getconf _NPROCESSORS_ONLN) -C build
        make -C build install

    - name: make installcheck
      if: steps.check.outputs.should_run == 'true'
      run: |
        TESTS="${{ steps.check.outputs.changed_tests }}"
        echo "Running tests: $TESTS"

        # Run all changed tests together, allow failure
        make -C build installcheck TESTS="$TESTS" 2>&1 | tee installcheck.log || true

    - name: Show regression diffs
      if: always() && steps.check.outputs.should_run == 'true'
      id: collectlogs
      run: |
        find . -name regression.diffs -exec cat {} + > regression.log
        if [[ -s regression.log ]]; then echo "regression_diff=true" >> $GITHUB_OUTPUT; fi
        grep -e 'FAILED' -e 'failed (ignored)' -e 'not ok' installcheck.log || true
        cat regression.log

    - name: Save regression diffs
      if: always() && steps.collectlogs.outputs.regression_diff == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: Regression diff PG${{ steps.config.outputs.PG17_LATEST }}
        path: |
          regression.log
          installcheck.log

    - name: Save PostgreSQL log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: PostgreSQL log ${{ matrix.os }} ${{ matrix.name }} ${{ matrix.pg }}
        path: postmaster.*

    - name: Verify tests failed on old code
      if: steps.check.outputs.should_run == 'true'
      run: |
        TESTS="${{ steps.check.outputs.changed_tests }}"

        if [[ ! -s regression.log ]]; then
          echo ""
          echo "ERROR: No test failures detected (regression.diffs is empty or missing)"
          echo "All tests passed when they should have failed."
          echo ""
          echo "This suggests these tests may not be testing the new code changes."
          echo "Please verify that your tests actually exercise the new functionality."
          echo ""
          cat installcheck.log
          exit 1
        fi

        # Extract test names from regression.log (lines like "diff -u .../expected/testname.out")
        FAILED_TESTS=$(grep -oE "expected/[a-zA-Z0-9_-]+\.out" regression.log | \
          sed 's|expected/||; s|\.out||; s|-[0-9]*$||' | sort -u | tr '\n' ' ')

        echo ""
        echo "=== Results ==="
        echo "Tests that failed: $FAILED_TESTS"
        echo ""

        # Check which changed tests did NOT fail
        PASSED_TESTS=""
        for TEST in $TESTS; do
          if ! echo "$FAILED_TESTS" | grep -qw "$TEST"; then
            PASSED_TESTS="$PASSED_TESTS $TEST"
          fi
        done

        if [[ -n "$PASSED_TESTS" ]]; then
          echo "WARNING: The following changed tests PASSED when they should have FAILED:"
          echo " $PASSED_TESTS"
          echo ""
          echo "This suggests these tests may not be testing the new code changes."
          echo "Please verify that your tests actually exercise the new functionality."
          exit 1
        fi

        echo "All changed tests failed as expected."
