name: "Build distribution packages"

"on":
  release:
    types: [published]

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Initialize build summary
      run: |
        echo "# ðŸ“¦ Distribution Package Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release Version:** \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Release URL:** [${{ github.event.release.name }}](${{ github.event.release.html_url }})" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Build Docker Image
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸ³ Triggering Docker image build..." | tee -a build.log
        if gh workflow run docker-image.yml -R timescale/timescaledb-docker -f version=${{ github.event.release.tag_name }} -f tag_latest=true -f registry=prod; then
          echo "| ðŸ³ Docker Image | âœ… Triggered | [timescaledb-docker](https://github.com/timescale/timescaledb-docker/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker build triggered successfully" | tee -a build.log
        else
          echo "| ðŸ³ Docker Image | âŒ Failed | [timescaledb-docker](https://github.com/timescale/timescaledb-docker/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Docker build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build Debian Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸ§ Triggering Debian package build..." | tee -a build.log
        if gh workflow run timescaledb-debian.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸ§ Debian Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Debian build triggered successfully" | tee -a build.log
        else
          echo "| ðŸ§ Debian Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Debian build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build Ubuntu Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸŸ  Triggering Ubuntu package build..." | tee -a build.log
        if gh workflow run timescaledb-ubuntu.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸŸ  Ubuntu Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Ubuntu build triggered successfully" | tee -a build.log
        else
          echo "| ðŸŸ  Ubuntu Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Ubuntu build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build ARM64 APT Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸ’ª Triggering ARM64 APT package build..." | tee -a build.log
        if gh workflow run timescaledb-apt-arm64.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸ’ª ARM64 APT Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ARM64 APT build triggered successfully" | tee -a build.log
        else
          echo "| ðŸ’ª ARM64 APT Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ ARM64 APT build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build RPM Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸ”´ Triggering RPM package build..." | tee -a build.log
        if gh workflow run timescaledb-rpm.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸ”´ RPM Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… RPM build triggered successfully" | tee -a build.log
        else
          echo "| ðŸ”´ RPM Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ RPM build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build Homebrew Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸº Triggering Homebrew package build..." | tee -a build.log
        if gh workflow run timescaledb-homebrew.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸº Homebrew Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Homebrew build triggered successfully" | tee -a build.log
        else
          echo "| ðŸº Homebrew Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Homebrew build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Build Windows Packages
      env:
        GH_TOKEN: ${{ secrets.ORG_AUTOMATION_TOKEN }}
      run: |
        echo "ðŸªŸ Triggering Windows package build..." | tee -a build.log
        if gh workflow run timescaledb-windows.yml -R timescale/release-build-scripts -f version=${{ github.event.release.tag_name }} -f upload-artifacts=true; then
          echo "| ðŸªŸ Windows Packages | âœ… Triggered | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Windows build triggered successfully" | tee -a build.log
        else
          echo "| ðŸªŸ Windows Packages | âŒ Failed | [release-build-scripts](https://github.com/timescale/release-build-scripts/actions) |" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Windows build failed to trigger" | tee -a build.log
          exit 1
        fi

    - name: Generate final summary
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Build Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count successful and failed builds
        SUCCESS_COUNT=$(grep -c "âœ… Triggered" $GITHUB_STEP_SUMMARY || echo "0")
        TOTAL_BUILDS=7
        
        echo "**Total Builds:** $TOTAL_BUILDS" >> $GITHUB_STEP_SUMMARY
        echo "**Successful:** $SUCCESS_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "**Failed:** $((TOTAL_BUILDS - SUCCESS_COUNT))" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$SUCCESS_COUNT" -eq "$TOTAL_BUILDS" ]; then
          echo "ðŸŽ‰ **All distribution packages triggered successfully!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Some package builds failed to trigger. Check the logs above.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. Monitor the triggered workflows in their respective repositories" >> $GITHUB_STEP_SUMMARY
        echo "2. Check build artifacts once workflows complete" >> $GITHUB_STEP_SUMMARY
        echo "3. Verify package availability in distribution channels" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
        
        # Show build log summary
        if [ -f build.log ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ðŸ“„ Detailed Build Log</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat build.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi